<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>高后果区识别与分析系统</title>

    <link rel="stylesheet" href="../../jasmvvm/lib/element-ui/v2.4.1/theme-chalk/index.min.css">
    <link rel="stylesheet" href="../../jasmvvm/lib/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../jasmvvm/src/css/main.css">
    <link rel="stylesheet" href="../../jasmvvm/src/css/onepage.css">
    <link rel="stylesheet" href="../../jasframework/common/lib/esri/3.18/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="../../jasframework/common/lib/esri/3.18/esri/css/esri.css">
    <link rel="stylesheet" href="../../jasframework/common/lib/esri/3.18/jasgroup/styles/default/style.css">
    <link rel="stylesheet" href="../../jasframework/common/lib/easyui/themes/default/easyui.css">
    <link rel="stylesheet" href="../../jasframework/common/lib/easyui/themes/icon.css">

    <style>
        .center{
            width: 100%;
            height: 100%;
            position: relative;
        }
        .map-info{
            position: absolute;
            bottom: 0;
            height: 20%;
            /* width: 100%; */
            width: 98%;
            /* padding: 50px; */
            padding: 36px;
            box-sizing: border-box;
            color: #72c1ea;
            /* color: #ffffff; */
            background-color: #060e224d;
            line-height: 30px;
            margin: 10px
        }
        .map-info p{
            text-indent: 30px;
        }
        .map-info span{
            color: #ffc000;
            font-size: 14px;
        }
        .operate-left-div {
            position: absolute;
            top: 110px;
            left: 0;
            display: inline-block;
            box-sizing: border-box;
            line-height: 34px;
            z-index: 10;
        }
        .area-div {
            position: absolute;
            top: 150px;
            left: 143px;
            display: inline-block;
            box-sizing: border-box;
            line-height: 34px;
            z-index: 10;
        }
        .hca-div {
            position: absolute;
            top: 230px;
            left: 143px;
            display: inline-block;
            box-sizing: border-box;
            line-height: 34px;
            z-index: 10;
        }
        .item-btn{
            /*icon:url(../../jasframework/map_viewer/images/dock/draw.png);*/
            cursor: pointer;
            color: rgb(184, 222, 255);
            height: 49px;
            line-height: 49px;
            text-align: center;
            width: 116px;
            background: url(../../jasmvvm/src/images/normal_right.png) no-repeat rgba(255, 255, 255, 0);
            margin: 26px 1px 0px;
        }
        .top-center{
            z-index: 20;
            position: absolute;
            background: url(../../jasmvvm/src/images/title.png);
            left: calc(50% - 327px);
            height: 89px;
            width: 654px;
        }
        .top-center:hover{
            cursor: pointer;
        }
        .undertop-center{
            z-index: 20;
            position: absolute;
            background: transparent;
            left: calc(50% - 327px);
            height: 50px;
            width: 654px;
        }
        .undertop-center:hover{
            cursor: pointer;
        }
        .el-icon-loading{
            font-size: 45px;
        }
        .el-loading-spinner .el-loading-text {
            color: #409EFF;
            margin: 3px 0;
            font-size: 35px;
        }
        .map-module-basemaptoolsbar ul li{
            display: block !important;
            padding: 1px !important;
            float: unset !important;
        }
        .map-module-basemaptoolsbar {
            position: absolute;
            top: 255px  !important;
            right: 10px  !important;
            left: unset !important;
        }
        .title-div {
            position: absolute;
            left: 50%;
            top: 40px;
            transform: translateX(-50%);
            z-index: 10;
            color:#409eff;
        }
        .el-tag {
            border-color: #409EFF;
            padding: 0 5px !important;
        }
        .operate-left-div{
            left:1%;
            border-color: #409EFF;
        }
        .el-tabs--card>.el-tabs__header {
            border-bottom: 1px solid #409EFF;
        }
        .el-tabs--card>.el-tabs__header .el-tabs__nav {
            border: 1px solid #409EFF;
            background: rgba(0, 0, 0, 0.6);
            width:388px;
        }
        .el-tabs--card>.el-tabs__header .el-tabs__item.is-active {
            border-bottom-color: #409EFF;
        }
        .selftabs .el-tabs__item{
            padding: 0 !important;
        }
        .el-tabs__item {
            width:97px;
            padding-left: 3px;
            color: #fff;
            text-align: center!important;
        }
        .jas-dialog-self {
            border: 1px solid #409EFF;
            background: rgba(189, 187, 187, 0.8);
        }

        .jas-dialog-header {
            background:transparent;
            height: 30px;
            color: #409EFF;
        }
        .jas-dialog-tools {
            right: 10px;
            top: 0px;
        }
        .jas-dialog-close {
            width: 15px;
            height: 15px;
            background-size: 15px 15px;
        }
        .panel-body.panel-body-noborder.window-body{
            overflow-y:hidden
        }
        .area-btn{
            cursor: pointer;
            height: 29px;
            line-height: 49px;
            text-align: center;
            width: 20px;
            background: url(images/huafen.png) no-repeat;
            margin: 26px 1px 0px 6px;
            padding: 0px 5px 0px 5px !important;
            background-color: #3588d8;
            border: 1px solid #409EFF;
            background-position-x: center;
            background-position-y: center;
        }
        .hca-btn{
            cursor: pointer;
            height: 29px;
            line-height: 49px;
            text-align: center;
            width: 20px;
            background: url(images/shibie.png) no-repeat;
            margin: 26px 1px 0px 6px;
            padding: 0px 5px 0px 5px !important;
            background-color: #3588d8;
            border: 1px solid #409EFF;
            background-position-x: center;
            background-position-y: center;
        }
    </style>
</head>

<body >
<div id="app">
    <jas-onepage-wrapper :ismax="ismax">
        <template slot="center" >
            <div class="center">
                <div class="title-div" hidden>
                    <label>当前识别管线：</label>
                    <el-tag>  </el-tag>
                    <el-tooltip effect="dark" content="退出识别" placement="right">
                        <el-button style="padding: 8px 8px" type="primary" icon="el-icon-circle-close-outline" @click="exitHca"></el-button>
                    </el-tooltip>
                </div>
                <!--左侧流程操作按钮-->
                <div class="operate-left-div">
                    <div class="area-btn" @click="showHistoryBtn" v-show="isManage" title="地区等级划分"></div>
                    <div class="hca-btn" @click="createHcaArea" v-show="isManage" title="高后果区识别"></div>
                </div>
                <div id="jasMap" class="jasmap" style="height:100%;width:100%;background: transparent"></div>
            </div>
        </template>
    </jas-onepage-wrapper>
</div>
</body>
<!-- import Vue before Element -->
<script src="../../jasmvvm/lib/vue/vue.js"></script>
<script src="../../jasmvvm/lib/jquery/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../jasframework/common/lib/easyui/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../../jasframework/common/js/common.js"></script>
<script src="../../jasmvvm/lib/element-ui/v2.4.1/index.min.js"></script>
<script src="../../jasmvvm/common/components/jas-components.js"></script>
<script src="../../jasmvvm/common/js/jas-tools.js"></script>
<script src="../../jasmvvm/pages/row-onepage/hca-operation/components/onepage-components.js"></script>

<script>
    //在引入init.js文件之前，定义dojoConfig全局变量，设置arcgis 模块命名空间
    var dojoConfig = {
        "parseOnLoad": true,
        "async": true,
        "baseUrl":"../../jasframework/common/lib/esri/3.18/dojo"
    };
</script>

<!--arcgis依赖-->
<script src="../../jasframework/common/lib/esri/3.18/init.js"></script>
<script src="../../jasframework/common/lib/easyui/jquery.easyui.min.js"></script>
<script src="../../jasframework/common/lib/easyui/locale/easyui-lang-zh_CN.js"></script>
<script src="../../jasframework/common/js/mapjs/modules.js"></script>
<!--地图插件api-->
<script id="mapApi" data-config="config2.json" src="../../jasframework/common/js/mapjs/map2DApi.js"  ></script>

<script>
    /**
     * @desc 获取访问路径中某个参数
     *
     * @param paramName 参数名
     * @param url 指定要截取参数的url（可以为空，如果为空url指向当前页面）
     */
    function getParamter(paramName, url) {
        var seachUrl = window.location.search.replace("?", "");
        if (url != null) {
            var index = url.indexOf('?');
            url = url.substr(index + 1);
            seachUrl = url;
        }
        var ss = seachUrl.split("&");
        var paramNameStr = "";
        var paramNameIndex = -1;
        for ( var i = 0; i < ss.length; i++) {
            paramNameIndex = ss[i].indexOf("=");
            paramNameStr = ss[i].substring(0, paramNameIndex);
            if (paramNameStr == paramName) {
                var returnValue = ss[i].substring(paramNameIndex + 1, ss[i].length);
                if (typeof (returnValue) == "undefined") {
                    returnValue = "";
                }
                return returnValue;
            }
        }
        return "";
    }
    top.hcaMapApp = new Vue({
        el: '#app',
        data: function () {
            return {
                ismax: false,
                baiduKey:"",
                jasMap:null,
                mapConfig:"config2.json",
                layerId:"hca_pipeline",//空间表layerId (表名)
                layerKeyName:"hca_pipeline",//空间表layerId (表名)
                isManage:false,
                isShowPipeline:false,
                localPipelineName:'',
                activeName:'',
                pipelineOid:'fa692d8c-6dfe-41d6-a8e1-6303a5ebfae5',
                localAreaVersionOid:'',
 				localAddress:'',
                domainData:[]
            }
        },
        computed: {},
        mounted: function(){
        },
        created: function () {
            var that = this;

            that.jasMap = new JasMap({
                appConfig:that.mapConfig,
                onConfigLoaded:function(config){
                    that.baiduKey = config.context["baidu-key"];
                },
                onOptionalLayersLoaded:function(){
                    that.jasMap.updateLayer('hca_pipeline',{
                        "show":true
                    })
                }
            });
            top.jasMap = that.jasMap;
            parent.jasMap = that.jasMap;
            window.jasMap = that.jasMap;
            that.jasMap.showHistoryBtn = this.showHistoryBtn;
            that.jasMap.createHcaArea = this.createHcaArea;
            that.jasMap.drawSettlement = this.drawSettlement;
            //that.jasMap.deleteSettlement = this.deleteSettlement;
            top.createBufferDialog = that.createBufferDialog;
            top.createBuffer = that.createBuffer;
            top.randomSettlementData = that.randomSettlementData;
            top.showHistoryList = that.showHistoryList;
            top.pipelineOid = that.pipelineOid;
            top.showAreaDialogRight = that.showAreaDialogRight;
            top.closeBufferWindow = that.closeBufferWindow;
        },
        watch: {
            // 如果需要联动
            areaVal: function (newval, oldval) {
            },
            // 地图最大化的监控
            ismax:function (newval, oldval) {
                var that = this;
                this.$nextTick(function(){
                    that.jasMap.resizeMap()
                })
            },
        },
        methods: {
            callback1:function(e){
                this.localAddress = e.result.formatted_address;
                var fId = new Date().getTime();
                var baseSrc = jasTools.base.rootPath + '/jasmvvm/pages/row-onepage/hca-operation/dialogs/base-template/dialogs/add-settlement.html?fId=' + fId + "&layerId=drawlayer_hca_buildings&localAddress=" + encodeURI(this.localAddress)
                window.getDlg(baseSrc, "editSettlementIframe", "建(构)筑物属性编辑", 320, 350);
            }  ,
            drawSettlement: function(){
                var that = this;
                this.jasMap.drawPolygon({
                    layerId: "drawlayer_hca_buildings",
                    onDrawEnd:function(evt){
                        var feature = evt ;
                        var fId = new Date().getTime();
                        feature.attributes = { id :fId};
                        //changedFeatures[fId] = feature;
                        var locationCenter = that.jasMap.getCenterLocation(feature.geometry);
                        var location = locationCenter.y +","+ locationCenter.x;
                        var key = that.baiduKey;
                        var url = "http://api.map.baidu.com/reverse_geocoding/v3/?ak="+key+"&output=json&coordtype=wgs84ll&callback=top.hcaMapApp.callback1&location="+location;
                        $.getScript(url);
                    }
                })
            },
            createBufferDialog: function(pipelineOid){	// 调用识别区窗口
                var that = this;
                this.pipelineOid = pipelineOid;
                this.closeBufferWindow();
                $("span[class=el-tag]").html(that.localPipelineName);
                $('.title-div').show();
                window.getDlg(jasTools.base.rootPath + '/jasmvvm/pages/row-onepage/hca-operation/dialogs/base-template/dialogs/buffer.html', "bufferIframe", "识别区条件", 230,150);
            },
            closeBufferWindow: function(){
                $('span.jas-dialog-close').trigger('click');
            },
            createBuffer: function(){	// 调用识别区生成方法
                var that = this;
                var radius = app.bufferValue;
                that.isManage = app.isManage;
                window.jasTools.selfDialog.close();
                this.jasMap.commonUtil.simpleAjaxLoader({
                    url:jasTools.base.rootPath + "/analysis/area.do",
                    data:JSON.stringify({
                        "pipesegmentTableName":"hca_pipeline",
                        "pipesegmentKeyValue":that.pipelineOid,
                        "pipesegmentKeyName":"oid",
                        "bufferDistance":radius
                    }),
                    contentType:"application/json;charset=utf-8",
                    method:"post",
                    async:false,
                    onSuccess:function(result){
                        var json = JSON.parse(result);
                        var rings = json.data .rings;
                        that.jasMap.clearGraphicsLayer('drawlayer_area_buffer');
                        this.jasMap.addPolygonGraphic(rings,{
                            layerId:'drawlayer_area_buffer',
                            color:[255,255,255,100],
                            outlineColor:[255,0,0,255],
                        });
                        var lineGraphic = that.getPipeline();
                        var x = lineGraphic.geometry.paths[0][0][0];
                        var y = lineGraphic.geometry.paths[0][0][1] - 0.003;
                        this.jasMap.zoomAt(15,x ,y );
                    }
                });
            },
            getPipeline: function(){
                var layer = this.jasMap.getLayerById('hca_pipeline');
                return layer.graphics[0];
            },
            close: function(){
                window.jasTools.dialog.close();
            },
            randomSettlementData: function(){
                var that = this;
                var common = this.jasMap.commonUtil;
                var msg = "确认重新生成地区等级？";
                var settlementLayerId = "hca_buidings";
                //top.Vue.prototype.$confirm(msg , "提示", {
                that.$confirm(msg , "提示", {
                    type: 'warning',
                    callback: function (action) {
                        if (action === 'confirm') {
                            that.jasMap.layerVisibleSwitch( "hca_high_impact_area" ,false);
                            //const loading = top.Vue.prototype.$loading({
                            const loading = that.$loading({
                                lock: true,
                                text: '合并要素单元......',
                                spinner: 'el-icon-loading',
                                background: 'rgba(0, 0, 0, 0.7)',
                                height: "50px"
                            });
                            setTimeout(function(){
                                loading.text='地区等级划分......';
                            }, 2000);
                            common.simpleAjaxLoader({
                                url:jasTools.base.rootPath + "/analysis/area/grade.do",
                                data: JSON.stringify({
                                    pipesegmentKeyValue: that.pipelineOid,
                                    bufferDistance:app.bufferValue,
                                }) ,
                                method:"post",
                                contentType:"application/json",
                                async: true,
                                onSuccess: function(res){
                                    var result = JSON.parse(res) ;
                                    loading.close();
                                    that.saveVersion('0',result.data.versionId);
                                    that.jasMap.updateLayer('hca_area',{
                                        "show":true,
                                        "where":"version_oid like'" + result.data.versionId + "'"
                                    });
                                    var lineGraphic = that.getPipeline();
                                    var x = lineGraphic.geometry.paths[0][0][0];
                                    var y = lineGraphic.geometry.paths[0][0][1] - 0.003;
                                    that.jasMap.zoomAt(15,x ,y );
                                },
                                onError: function(){
                                    that.$alert('数据处理出错', '提示');
                                    //top.Vue.prototype.$alert('数据处理出错', '提示');
                                    loading.close();
                                }
                            });
                        }
                    }
                });
            },
            showAreaDialogCreate: function(forBusiness, title, top){
                window.jasTools.selfDialog.show({
                    title: title,
                    src: jasTools.base.rootPath + '/jasmvvm/pages/row-onepage/hca-operation/dialogs/base-template/dialogs/area-divide-list.html?forBusiness=' + forBusiness,
                    height: '485px',
                    width: '320px',
                    top:'100px',
                    left:'5%'
                })
            },
            showAreaDialogRight: function(forBusiness,title,versionOid){
                this.localAreaVersionOid = versionOid;
                if(forBusiness == 0){
                    window.jasTools.selfDialog.show({
                        title: title,
                        src: jasTools.base.rootPath + '/jasmvvm/pages/row-onepage/hca-operation/dialogs/base-template/dialogs/area-divide-list.html?forBusiness=' + forBusiness + '&versionOid='+versionOid,
                        height: '480px',
                        width: '320px',
                        top:'80px',
                        right:'2%'
                    })
                }else {
                    window.jasTools.selfDialog.show({
                        title: title,
                        src: jasTools.base.rootPath + '/jasmvvm/pages/row-onepage/hca-operation/dialogs/base-template/dialogs/hca-list.html?forBusiness=' + forBusiness + '&versionOid='+versionOid,
                        height: '480px',
                        width: '320px',
                        top:'80px',
                        right:'2%'
                    })
                }
            },
            refreshAreaRankDialog: function(data){
                var module = this.jasMap.getModuleById("areaRankManager");
                if(!module){
                    return
                }
                module.open(true);
                module.refresh(data);
            },
            //1、拿到地区等级版本，发起请求，计算高后果区，返回高后果计算结果版本code
            //2、通过code刷新高后果区图层 updateLayer() ; where :"code=="
            createHcaArea: function(){// 1.计算影响区 2.加载特定场所/易燃易爆场所 3.计算高后果区
                var that = this;
                var localAreaVersionOid = app.localAreaVersionOid; //that.localAreaVersionOid;
                this.jasMap.startPanMode();
                this.closeBufferWindow();
                if(!this.jasMap.getLayerVisible('hca_area')){
                    //top.Vue.prototype.$alert('请先进行地区等级划分', '提示', {
                    that.$alert('请先进行地区等级划分', '提示', {
                        type: 'warning',
                        callback: function(){
                        }
                    });
                    return;
                }
                var common = this.jasMap.commonUtil;
                //top.Vue.prototype.$confirm('生成新的高后果区？',  "提示",  {
                that.$confirm('生成新的高后果区？',  "提示",  {
                    type: 'warning',
                    callback: function(action){
                        if (action === 'confirm') {
                            //var loading = top.Vue.prototype.$loading({
                            var loading = that.$loading({
                                lock: true,
                                text: '计算影响区域......',
                                spinner: 'el-icon-loading',
                                background: 'rgba(0, 0, 0, 0.7)'
                            });
                            setTimeout(function(){
                                loading.text='高后果区识别......';
                            }, 2000);
                            common.simpleAjaxLoader({
                                url:jasTools.base.rootPath + "/analysis/high/"+localAreaVersionOid+"/doHcaAnalysis.do",
                                data: JSON.stringify({
                                }) ,
                                async: true,
                                onSuccess: function(res){
                                    var result = JSON.parse(res) ;
                                    loading.close();
                                    that.saveVersion('1',result.data.versionId);
                                    that.jasMap.updateLayer('hca_high_impact_area',{
                                        "show":true,
                                        "where":"version_oid like'" + result.data.versionId + "'"
                                    });
                                    var lineGraphic = that.getPipeline();
                                    var x = lineGraphic.geometry.paths[0][0][0];
                                    var y = lineGraphic.geometry.paths[0][0][1] - 0.003;
                                    that.jasMap.zoomAt(15,x ,y );
                                },
                                onError: function(){
                                    that.$alert('数据处理出错', '提示')
                                    //top.Vue.prototype.$alert('数据处理出错', '提示')
                                    loading.close();
                                }
                            });
                        }
                    }
                })
            },
            showHistoryBtn: function(){	// 打开地区等级选择窗口
                var that = this;
                this.jasMap.startPanMode();
                this.closeBufferWindow();
                window.getDlg(jasTools.base.rootPath + '/jasmvvm/pages/row-onepage/hca-operation/dialogs/base-template/dialogs/select-area.html', "areaSelectIframe", "地区等级划分", 340,140);
            },
            showHistoryList: function(forBusiness){
                var that = this;
                window.jasTools.selfDialog.close(this.closeBufferWindow());
                if(forBusiness == "0"){
                    window.getDlg(jasTools.base.rootPath + '/jasmvvm/pages/row-onepage/hca-operation/dialogs/base-template/dialogs/area-version-list.html?forBusiness=0&pipelineOid='+that.pipelineOid, "areaVersionSelectIframe", "地区等级划分成果", 360,400);
                }
                if(forBusiness == "1"){
                    window.getDlg(jasTools.base.rootPath + '/jasmvvm/pages/row-onepage/hca-operation/dialogs/base-template/dialogs/area-version-list.html?forBusiness=1&pipelineOid='+that.pipelineOid, "areaVersionSelectIframe", "高后果区识别成果", 360,400);
                }
            },
            exitHca: function(){
                var that = this;
                that.$confirm('是否退出识别？（未保存识别信息将丢失）',  "提示",  {
                    type: 'warning',
                    callback: function(action){
                        if (action === 'confirm') {
                            window.location.reload();
                        }

                    }
                });
            },
            saveVersion: function(forBusiness,versionOid){
                var that = this;
                var title = "新增高后果区识别成果";
                if(forBusiness=="0"){
                    title = "新增地区等级划分成果";
                }
                window.getDlg(jasTools.base.rootPath + '/jasmvvm/pages/row-onepage/hca-operation/dialogs/base-template/dialogs/add-version.html?forBusiness=' + forBusiness + '&pipelineOid='+that.pipelineOid + '&versionOid='+versionOid, "createVersionIframe", title, 300,330);
            },
            loadDomainData:function(){
                var _this = this ;
                if(_this.domainData.length > 0){
                    return top.domainData;
                }
                $.ajax({
                    url:getRootPath() + "basedata/domain/all.do",
                    dataType:"json",
                    async:false,
                    type:"post",
                    success:function(re){
                        _this.domainData = re.data;
                        console.info("成功获取"+ re.data.length +"条阈值数据" )
                    },
                    error:function(e){
                        console.error(e);
                    }
                });
                return _this.domainData;
            }
        }
    })
</script>

</html>